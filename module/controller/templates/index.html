<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Soul Chat Robot - 安卓自动化控制</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <div class="container-fluid">
        <header class="py-3 mb-3 border-bottom">
            <div class="container-fluid d-flex align-items-center">
                <h1 class="h4 me-auto mb-0">
                    <i class="bi bi-robot"></i> Soul Chat Robot - 安卓自动化控制
                </h1>
                <div class="device-status ms-3">
                    <span id="connection-status" class="badge bg-danger">未连接</span>
                    <span id="device-info"></span>
                </div>
            </div>
        </header>

        <div class="row">
            <!-- 左侧面板 - 设备控制与截图 -->
            <div class="col-md-6">
                <div class="card mb-3">
                    <div class="card-header">
                        <i class="bi bi-phone"></i> 设备控制
                    </div>
                    <div class="card-body">
                        <div class="d-flex mb-3">
                            <select id="device-select" class="form-select me-2">
                                <option value="">-- 选择设备 --</option>
                            </select>
                            <button id="refresh-devices" class="btn btn-outline-secondary">
                                <i class="bi bi-arrow-clockwise"></i>
                            </button>
                            <button id="connect-device" class="btn btn-primary ms-2">
                                连接
                            </button>
                        </div>
                        
                        <div class="d-flex justify-content-between mb-3">
                            <button id="take-screenshot" class="btn btn-success" disabled>
                                <i class="bi bi-camera"></i> 截图
                            </button>
                            <div class="btn-group">
                                <button id="btn-back" class="btn btn-secondary" disabled>
                                    <i class="bi bi-arrow-left"></i> 返回
                                </button>
                                <button id="btn-home" class="btn btn-secondary" disabled>
                                    <i class="bi bi-house"></i> Home
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="card mb-3">
                    <div class="card-header">
                        <i class="bi bi-image"></i> 设备屏幕
                        <small id="screen-resolution" class="text-muted"></small>
                        <span class="float-end">
                            <span id="screenshot-time" class="text-muted"></span>
                        </span>
                    </div>
                    <div class="card-body p-0 position-relative">
                        <div id="screenshot-container" class="text-center">
                            <div id="no-screenshot" class="p-5">
                                <i class="bi bi-phone-landscape display-1 text-muted"></i>
                                <p class="text-muted">请连接设备并点击截图按钮</p>
                            </div>
                            <img id="screenshot-img" class="img-fluid d-none" src="">
                            
                            <!-- 点击信息叠加层 -->
                            <div id="screen-overlay" class="position-absolute top-0 start-0 w-100 h-100 d-none">
                                <div id="tap-indicator" class="position-absolute d-none">
                                    <div class="tap-circle"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card-footer">
                        <div class="d-flex">
                            <div class="me-auto">
                                <span id="tap-coordinates" class="text-muted">点击坐标: -</span>
                            </div>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="enable-tap" disabled>
                                <label class="form-check-label" for="enable-tap">启用点击</label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 右侧面板 - 任务管理 -->
            <div class="col-md-6">
                <div class="card mb-3">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <div>
                            <i class="bi bi-list-check"></i> 任务管理
                        </div>
                        <div class="btn-group">
                            <button id="btn-new-task" class="btn btn-sm btn-primary">
                                <i class="bi bi-plus"></i> 新建任务
                            </button>
                            <button id="btn-save-tasks" class="btn btn-sm btn-outline-secondary">
                                <i class="bi bi-save"></i> 保存
                            </button>
                            <button id="btn-load-tasks" class="btn btn-sm btn-outline-secondary">
                                <i class="bi bi-folder-open"></i> 加载
                            </button>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div id="task-list" class="list-group list-group-flush">
                            <!-- 任务列表将通过JavaScript动态生成 -->
                            <div class="list-group-item text-center text-muted py-5">
                                <i class="bi bi-clipboard-x display-6"></i>
                                <p>暂无任务</p>
                                <button id="btn-create-first-task" class="btn btn-sm btn-outline-primary">
                                    创建第一个任务
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="card mb-3">
                    <div class="card-header">
                        <i class="bi bi-info-circle"></i> 操作说明
                    </div>
                    <div class="card-body">
                        <h5>基本操作</h5>
                        <ul>
                            <li>连接设备: 从下拉菜单选择设备并点击"连接"</li>
                            <li>截图: 点击"截图"按钮获取当前屏幕图像</li>
                            <li>点击: 启用点击功能后，直接点击屏幕图像进行操作</li>
                        </ul>
                        
                        <h5>任务管理</h5>
                        <ul>
                            <li>创建任务: 点击"新建任务"按钮</li>
                            <li>执行任务: 点击任务列表中的"执行"按钮</li>
                            <li>编辑任务: 点击任务列表中的"编辑"按钮</li>
                            <li>嵌套条件: 可以创建包含子任务的条件任务</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 任务编辑模态框 -->
    <div class="modal fade" id="task-modal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="task-modal-title">编辑任务</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="task-form">
                        <input type="hidden" id="task-id">
                        
                        <div class="mb-3">
                            <label for="task-name" class="form-label">任务名称</label>
                            <input type="text" class="form-control" id="task-name" required>
                        </div>
                        
                        <div class="mb-3">
                            <label for="task-description" class="form-label">描述</label>
                            <textarea class="form-control" id="task-description" rows="2"></textarea>
                        </div>
                        
                        <div class="mb-3">
                            <label for="task-type" class="form-label">任务类型</label>
                            <select class="form-select" id="task-type">
                                <option value="simple">简单任务</option>
                                <option value="conditional">条件任务</option>
                                <option value="loop">循环任务</option>
                            </select>
                        </div>
                        
                        <!-- 循环次数 (只有循环任务显示) -->
                        <div class="mb-3 d-none" id="loop-count-group">
                            <label for="loop-count" class="form-label">循环次数</label>
                            <input type="number" class="form-control" id="loop-count" min="1" value="1">
                        </div>
                        
                        <!-- 条件设置 (只有条件任务显示) -->
                        <div class="mb-3 d-none" id="conditions-group">
                            <label class="form-label">条件设置</label>
                            <div class="card">
                                <div class="card-header bg-light d-flex justify-content-between align-items-center">
                                    <span>检测条件</span>
                                    <button type="button" id="add-condition" class="btn btn-sm btn-outline-primary">
                                        <i class="bi bi-plus"></i> 添加条件
                                    </button>
                                </div>
                                <div class="card-body p-0">
                                    <div id="conditions-list" class="list-group list-group-flush">
                                        <!-- 条件列表将通过JavaScript动态生成 -->
                                        <div class="list-group-item text-center text-muted py-3" id="no-conditions">
                                            <p>暂无条件，点击"添加条件"按钮创建</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 动作设置 -->
                        <div class="mb-3">
                            <label class="form-label">动作设置</label>
                            <div class="card">
                                <div class="card-header bg-light d-flex justify-content-between align-items-center">
                                    <span>执行动作</span>
                                    <div class="btn-group">
                                        <button type="button" class="btn btn-sm btn-outline-primary dropdown-toggle" data-bs-toggle="dropdown">
                                            <i class="bi bi-plus"></i> 添加动作
                                        </button>
                                        <ul class="dropdown-menu">
                                            <li><a class="dropdown-item add-action" data-type="tap" href="#">点击屏幕</a></li>
                                            <li><a class="dropdown-item add-action" data-type="input" href="#">输入文本</a></li>
                                            <li><a class="dropdown-item add-action" data-type="wait" href="#">等待</a></li>
                                            <li><a class="dropdown-item add-action" data-type="key" href="#">按键</a></li>
                                            <li><a class="dropdown-item add-action" data-type="swipe" href="#">滑动屏幕</a></li>
                                        </ul>
                                    </div>
                                </div>
                                <div class="card-body p-0">
                                    <div id="actions-list" class="list-group list-group-flush">
                                        <!-- 动作列表将通过JavaScript动态生成 -->
                                        <div class="list-group-item text-center text-muted py-3" id="no-actions">
                                            <p>暂无动作，点击"添加动作"按钮创建</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 子任务设置 (只有条件和循环任务显示) -->
                        <div class="mb-3 d-none" id="children-group">
                            <label class="form-label">子任务设置</label>
                            <div class="card">
                                <div class="card-header bg-light d-flex justify-content-between align-items-center">
                                    <span>子任务</span>
                                    <button type="button" id="add-child-task" class="btn btn-sm btn-outline-primary">
                                        <i class="bi bi-plus"></i> 添加子任务
                                    </button>
                                </div>
                                <div class="card-body p-0">
                                    <div id="children-list" class="list-group list-group-flush">
                                        <!-- 子任务列表将通过JavaScript动态生成 -->
                                        <div class="list-group-item text-center text-muted py-3" id="no-children">
                                            <p>暂无子任务，点击"添加子任务"按钮创建</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" id="save-task">保存任务</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 条件编辑模态框 -->
    <div class="modal fade" id="condition-modal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">编辑条件</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="condition-form">
                        <input type="hidden" id="condition-id">
                        
                        <div class="mb-3">
                            <label for="condition-type" class="form-label">条件类型</label>
                            <select class="form-select" id="condition-type">
                                <option value="text">文本检测</option>
                                <option value="template">图像模板匹配</option>
                            </select>
                        </div>
                        
                        <!-- 文本检测内容 -->
                        <div class="mb-3" id="text-condition-group">
                            <label for="condition-content" class="form-label">检测内容</label>
                            <input type="text" class="form-control" id="condition-content">
                            <div class="form-text">
                                输入要检测的文本内容，如"登录"、"确认"等
                            </div>
                        </div>
                        
                        <!-- 图像模板匹配 -->
                        <div class="mb-3 d-none" id="template-condition-group">
                            <label class="form-label">模板图片</label>
                            <div class="input-group mb-3">
                                <input type="file" class="form-control" id="template-image-file" accept="image/*">
                                <button class="btn btn-outline-secondary" type="button" id="upload-template-btn">
                                    上传
                                </button>
                            </div>
                            <div id="template-preview-container" class="d-none mb-3">
                                <div class="card">
                                    <div class="card-body p-2">
                                        <div class="d-flex align-items-center">
                                            <img id="template-preview" class="img-thumbnail me-3" style="max-height: 100px;">
                                            <div>
                                                <h6 id="template-name" class="mb-1"></h6>
                                                <small id="template-status" class="text-muted"></small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="form-text mb-3">
                                上传要匹配的模板图片，系统将在屏幕中查找此图像
                            </div>
                            
                            <label class="form-label">匹配区域（可选）</label>
                            <div class="row g-2 mb-2">
                                <div class="col-6">
                                    <div class="input-group input-group-sm">
                                        <span class="input-group-text">X</span>
                                        <input type="number" class="form-control" id="template-region-x" value="0" min="0">
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="input-group input-group-sm">
                                        <span class="input-group-text">Y</span>
                                        <input type="number" class="form-control" id="template-region-y" value="0" min="0">
                                    </div>
                                </div>
                            </div>
                            <div class="row g-2 mb-2">
                                <div class="col-6">
                                    <div class="input-group input-group-sm">
                                        <span class="input-group-text">宽</span>
                                        <input type="number" class="form-control" id="template-region-width" value="0" min="0">
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="input-group input-group-sm">
                                        <span class="input-group-text">高</span>
                                        <input type="number" class="form-control" id="template-region-height" value="0" min="0">
                                    </div>
                                </div>
                            </div>
                            <div class="form-text">
                                可以指定屏幕上的特定区域进行匹配，不填则匹配整个屏幕
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="condition-analyzer" class="form-label">分析器</label>
                            <select class="form-select" id="condition-analyzer">
                                <option value="ocr">OCR分析器 (文字识别)</option>
                                <option value="ai">AI分析器 (综合分析)</option>
                                <option value="template" class="d-none template-analyzer-option">模板匹配</option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label for="condition-confidence" class="form-label">
                                匹配置信度: <span id="confidence-value">0.7</span>
                            </label>
                            <input type="range" class="form-range" id="condition-confidence" 
                                   min="0.1" max="1.0" step="0.1" value="0.7">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" id="save-condition">保存条件</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 动作编辑模态框 -->
    <div class="modal fade" id="action-modal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="action-modal-title">编辑动作</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="action-form">
                        <input type="hidden" id="action-id">
                        <input type="hidden" id="action-type">
                        
                        <div class="mb-3">
                            <label for="action-name" class="form-label">动作名称</label>
                            <input type="text" class="form-control" id="action-name" required>
                        </div>
                        
                        <!-- 点击动作 -->
                        <div id="tap-action-fields" class="action-fields d-none">
                            <div class="mb-3">
                                <label class="form-label">点击坐标</label>
                                <div class="input-group">
                                    <span class="input-group-text">X</span>
                                    <input type="number" class="form-control" id="tap-x" required>
                                    <span class="input-group-text">Y</span>
                                    <input type="number" class="form-control" id="tap-y" required>
                                    <button type="button" class="btn btn-outline-secondary" id="pick-coordinates">
                                        <i class="bi bi-crosshair"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 输入文本动作 -->
                        <div id="input-action-fields" class="action-fields d-none">
                            <div class="mb-3">
                                <label for="input-text" class="form-label">输入文本</label>
                                <textarea class="form-control" id="input-text" rows="3" required></textarea>
                            </div>
                        </div>
                        
                        <!-- 等待动作 -->
                        <div id="wait-action-fields" class="action-fields d-none">
                            <div class="mb-3">
                                <label for="wait-seconds" class="form-label">等待时间（秒）</label>
                                <input type="number" class="form-control" id="wait-seconds" min="0.1" step="0.1" value="1" required>
                            </div>
                        </div>
                        
                        <!-- 按键动作 -->
                        <div id="key-action-fields" class="action-fields d-none">
                            <div class="mb-3">
                                <label for="key-code" class="form-label">按键选择</label>
                                <select class="form-select" id="key-code" required>
                                    <option value="3">Home键</option>
                                    <option value="4">返回键</option>
                                    <option value="26">电源键</option>
                                    <option value="24">音量+</option>
                                    <option value="25">音量-</option>
                                    <option value="66">回车键</option>
                                    <option value="61">Tab键</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- 滑动动作 -->
                        <div id="swipe-action-fields" class="action-fields d-none">
                            <div class="mb-3">
                                <label class="form-label">起始坐标</label>
                                <div class="input-group mb-2">
                                    <span class="input-group-text">X1</span>
                                    <input type="number" class="form-control" id="swipe-x1" required>
                                    <span class="input-group-text">Y1</span>
                                    <input type="number" class="form-control" id="swipe-y1" required>
                                </div>
                                <label class="form-label">结束坐标</label>
                                <div class="input-group mb-2">
                                    <span class="input-group-text">X2</span>
                                    <input type="number" class="form-control" id="swipe-x2" required>
                                    <span class="input-group-text">Y2</span>
                                    <input type="number" class="form-control" id="swipe-y2" required>
                                </div>
                                <label for="swipe-duration" class="form-label">持续时间（毫秒）</label>
                                <input type="number" class="form-control" id="swipe-duration" min="100" step="50" value="300" required>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" id="save-action">保存动作</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 子任务选择模态框 -->
    <div class="modal fade" id="child-task-modal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">选择子任务</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="list-group" id="child-task-list">
                        <!-- 子任务列表将通过JavaScript动态生成 -->
                        <div class="list-group-item text-center text-muted py-3" id="no-available-tasks">
                            <p>暂无可用任务</p>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 坐标选择模态框 -->
    <div class="modal fade" id="coordinate-picker-modal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">选择坐标点</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body p-0">
                    <div class="position-relative">
                        <img id="picker-screenshot" class="img-fluid w-100" src="">
                        <div id="picker-overlay" class="position-absolute top-0 start-0 w-100 h-100">
                            <div id="picker-indicator" class="position-absolute">
                                <div class="picker-circle"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <span id="picker-coordinates" class="me-auto">坐标: (0, 0)</span>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" id="confirm-coordinates">确认选择</button>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/uuid@8.3.2/dist/umd/uuidv4.min.js"></script>
    <script src="{{ url_for('static', filename='js/app.js') }}"></script>
</body>
</html>
