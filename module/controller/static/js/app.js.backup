/**
 * Soul Chat Robot - Web界面前端脚本
 * 完整功能版本，支持所有后端API
 */

// 全局变量
let currentTasks = [];
let editingTask = null;
let editingCondition = null;
let editingAction = null;
let coordinatePickerCallback = null;

// 当文档加载完成后执行初始化
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM已加载，初始化应用...');
    initApp();
});

// 应用初始化
function initApp() {
    // 获取DOM元素
    const elements = {
        // 设备控制
        deviceSelect: document.getElementById('device-select'),
        refreshDevices: document.getElementById('refresh-devices'),
        connectDevice: document.getElementById('connect-device'),
        connectionStatus: document.getElementById('connection-status'),
        deviceInfo: document.getElementById('device-info'),
        
        // 截图
        takeScreenshot: document.getElementById('take-screenshot'),
        screenshotImg: document.getElementById('screenshot-img'),
        noScreenshot: document.getElementById('no-screenshot'),
        screenOverlay: document.getElementById('screen-overlay'),
        tapCoordinates: document.getElementById('tap-coordinates'),
        enableTap: document.getElementById('enable-tap'),
        
        // 按键
        btnBack: document.getElementById('btn-back'),
        btnHome: document.getElementById('btn-home'),
        
        // 任务管理
        btnNewTask: document.getElementById('btn-new-task'),
        btnCreateFirstTask: document.getElementById('btn-create-first-task'),
        btnSaveTasks: document.getElementById('btn-save-tasks'),
        btnLoadTasks: document.getElementById('btn-load-tasks'),
        taskList: document.getElementById('task-list')
    };
    
    // 检查关键元素是否存在
    for (const key in elements) {
        if (elements[key] === null) {
            console.error(`找不到元素: ${key}`);
        }
    }
    
    // 绑定设备控制事件
    bindDeviceEvents(elements);
    
    // 绑定任务管理事件
    bindTaskEvents(elements);
    
    // 绑定模态框事件
    bindModalEvents();
    
    // 初始化数据
    fetchDevices();
    loadTasks();
    
    console.log('应用初始化完成');
}

// 绑定设备控制事件
function bindDeviceEvents(elements) {
    if (elements.refreshDevices) {
        elements.refreshDevices.addEventListener('click', function() {
            console.log('刷新设备列表');
            fetchDevices();
        });
    }
    
    if (elements.connectDevice) {
        elements.connectDevice.addEventListener('click', function() {
            console.log('连接设备');
            connectSelectedDevice();
        });
    }
    
    if (elements.takeScreenshot) {
        elements.takeScreenshot.addEventListener('click', function() {
            console.log('获取截图');
            takeScreenshot();
        });
    }
    
    if (elements.btnBack) {
        elements.btnBack.addEventListener('click', function() {
            console.log('按下返回键');
            pressKey(4);
        });
    }
    
    if (elements.btnHome) {
        elements.btnHome.addEventListener('click', function() {
            console.log('按下Home键');
            pressKey(3);
        });
    }
    
    if (elements.enableTap) {
        elements.enableTap.addEventListener('change', function(event) {
            console.log('切换点击功能:', event.target.checked);
            toggleTapFeature(event.target.checked);
        });
    }
    
    if (elements.screenOverlay) {
        elements.screenOverlay.addEventListener('click', function(event) {
            handleScreenTap(event);
        });
    }
}

// 绑定任务管理事件
function bindTaskEvents(elements) {
    if (elements.btnNewTask) {
        elements.btnNewTask.addEventListener('click', function() {
            console.log('创建新任务');
            openTaskModal();
        });
    }
    
    if (elements.btnCreateFirstTask) {
        elements.btnCreateFirstTask.addEventListener('click', function() {
            console.log('创建第一个任务');
            openTaskModal();
        });
    }
    
    if (elements.btnSaveTasks) {
        elements.btnSaveTasks.addEventListener('click', function() {
            console.log('保存任务');
            saveTasks();
        });
    }
    
    if (elements.btnLoadTasks) {
        elements.btnLoadTasks.addEventListener('click', function() {
            console.log('加载任务');
            loadTasksFromFile();
        });
    }
}

// 绑定模态框事件
function bindModalEvents() {
    // 任务模态框事件
    const taskModal = document.getElementById('task-modal');
    if (taskModal) {
        const saveTaskBtn = document.getElementById('save-task');
        const taskTypeSelect = document.getElementById('task-type');
        
        if (saveTaskBtn) {
            saveTaskBtn.addEventListener('click', saveCurrentTask);
        }
        
        if (taskTypeSelect) {
            taskTypeSelect.addEventListener('change', onTaskTypeChange);
        }
        
        // 绑定添加条件按钮
        const addConditionBtn = document.getElementById('add-condition');
        if (addConditionBtn) {
            addConditionBtn.addEventListener('click', openConditionModal);
        }
        
        // 绑定添加动作按钮
        const addActionButtons = document.querySelectorAll('.add-action');
        addActionButtons.forEach(btn => {
            btn.addEventListener('click', function(e) {
                e.preventDefault();
                const actionType = this.getAttribute('data-type');
                openActionModal(actionType);
            });
        });
        
        // 绑定添加子任务按钮
        const addChildTaskBtn = document.getElementById('add-child-task');
        if (addChildTaskBtn) {
            addChildTaskBtn.addEventListener('click', openChildTaskModal);
        }
    }
    
    // 条件模态框事件
    const conditionModal = document.getElementById('condition-modal');
    if (conditionModal) {
        const saveConditionBtn = document.getElementById('save-condition');
        const conditionTypeSelect = document.getElementById('condition-type');
        const confidenceRange = document.getElementById('condition-confidence');
        
        if (saveConditionBtn) {
            saveConditionBtn.addEventListener('click', saveCurrentCondition);
        }
        
        if (conditionTypeSelect) {
            conditionTypeSelect.addEventListener('change', onConditionTypeChange);
        }
        
        if (confidenceRange) {
            confidenceRange.addEventListener('input', function() {
                document.getElementById('confidence-value').textContent = this.value;
            });
        }
    }
    
    // 动作模态框事件
    const actionModal = document.getElementById('action-modal');
    if (actionModal) {
        const saveActionBtn = document.getElementById('save-action');
        const pickCoordinatesBtn = document.getElementById('pick-coordinates');
        
        if (saveActionBtn) {
            saveActionBtn.addEventListener('click', saveCurrentAction);
        }
        
        if (pickCoordinatesBtn) {
            pickCoordinatesBtn.addEventListener('click', openCoordinatePicker);
        }
    }
    
    // 坐标选择模态框事件
    const coordinatePickerModal = document.getElementById('coordinate-picker-modal');
    if (coordinatePickerModal) {
        const confirmCoordinatesBtn = document.getElementById('confirm-coordinates');
        const pickerOverlay = document.getElementById('picker-overlay');
        
        if (confirmCoordinatesBtn) {
            confirmCoordinatesBtn.addEventListener('click', confirmCoordinateSelection);
        }
        
        if (pickerOverlay) {
            pickerOverlay.addEventListener('click', handleCoordinatePickerClick);
        }
    }
}

// 获取设备列表
function fetchDevices() {
    fetch('/devices')
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                updateDeviceList(data.devices, data.connected_device);
            } else {
                showError('获取设备列表失败');
            }
        })
        .catch(error => {
            console.error('获取设备列表出错:', error);
            showError('网络错误，无法获取设备列表');
        });
}

// 更新设备列表
function updateDeviceList(devices, connectedDevice) {
    const deviceSelect = document.getElementById('device-select');
    if (!deviceSelect) return;
    
    // 清空设备列表
    deviceSelect.innerHTML = '<option value="">-- 选择设备 --</option>';
    
    // 添加设备选项
    if (devices && devices.length > 0) {
        devices.forEach(device => {
            const option = document.createElement('option');
            option.value = device.id;
            option.textContent = `${device.id} (${device.model || '未知型号'})`;
            
            // 如果是当前连接的设备，则选中
            if (device.id === connectedDevice) {
                option.selected = true;
                updateConnectionStatus(true, device);
            }
            
            deviceSelect.appendChild(option);
        });
    } else {
        const option = document.createElement('option');
        option.value = "";
        option.textContent = "未找到设备";
        option.disabled = true;
        deviceSelect.appendChild(option);
    }
}

// 连接选中的设备
function connectSelectedDevice() {
    const deviceSelect = document.getElementById('device-select');
    if (!deviceSelect) return;
    
    const deviceId = deviceSelect.value;
    if (!deviceId) {
        showError('请选择一个设备');
        return;
    }
    
    // 显示连接中状态
    updateConnectionStatus('connecting');
    
    // 发送连接请求
    fetch('/connect', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ device_id: deviceId })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            updateConnectionStatus(true, { id: deviceId });
            enableDeviceControls(true);
            showSuccess(data.message || '设备连接成功');
        } else {
            updateConnectionStatus(false);
            showError(data.message || '连接设备失败');
        }
    })
    .catch(error => {
        console.error('连接设备出错:', error);
        updateConnectionStatus(false);
        showError('网络错误，无法连接设备');
    });
}

// 更新连接状态
function updateConnectionStatus(status, device) {
    const connectionStatus = document.getElementById('connection-status');
    const deviceInfo = document.getElementById('device-info');
    
    if (!connectionStatus || !deviceInfo) return;
    
    if (status === 'connecting') {
        connectionStatus.className = 'badge bg-warning';
        connectionStatus.textContent = '连接中...';
        deviceInfo.textContent = '';
        return;
    }
    
    if (status) {
        connectionStatus.className = 'badge bg-success';
        connectionStatus.textContent = '已连接';
        
        if (device) {
            deviceInfo.textContent = device.id;
        }
    } else {
        connectionStatus.className = 'badge bg-danger';
        connectionStatus.textContent = '未连接';
        deviceInfo.textContent = '';
    }
}

// 启用/禁用设备控制按钮
function enableDeviceControls(enabled) {
    const btnTakeScreenshot = document.getElementById('take-screenshot');
    const btnBack = document.getElementById('btn-back');
    const btnHome = document.getElementById('btn-home');
    const enableTap = document.getElementById('enable-tap');
    
    if (btnTakeScreenshot) btnTakeScreenshot.disabled = !enabled;
    if (btnBack) btnBack.disabled = !enabled;
    if (btnHome) btnHome.disabled = !enabled;
    if (enableTap) enableTap.disabled = !enabled;
}

// 获取屏幕截图
function takeScreenshot() {
    const screenshotImg = document.getElementById('screenshot-img');
    const noScreenshot = document.getElementById('no-screenshot');
    const screenResolution = document.getElementById('screen-resolution');
    const screenshotTime = document.getElementById('screenshot-time');
    
    if (!screenshotImg || !noScreenshot) return;
    
    // 显示加载状态
    if (screenshotImg.classList.contains('d-none')) {
        screenshotImg.classList.remove('d-none');
    }
    noScreenshot.classList.add('d-none');
    screenshotImg.src = 'data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==';
    
    fetch('/screenshot')
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                // 显示截图
                screenshotImg.src = 'data:image/png;base64,' + data.image;
                
                // 显示截图时间
                if (screenshotTime) {
                    const timestamp = new Date(data.timestamp);
                    screenshotTime.textContent = timestamp.toLocaleTimeString();
                }
                
                // 显示分辨率
                screenshotImg.onload = function() {
                    if (screenResolution) {
                        screenResolution.textContent = `${this.naturalWidth} × ${this.naturalHeight}`;
                    }
                };
            } else {
                showError(data.message || '获取截图失败');
                
                // 恢复无截图状态
                screenshotImg.classList.add('d-none');
                noScreenshot.classList.remove('d-none');
            }
        })
        .catch(error => {
            console.error('获取截图出错:', error);
            showError('网络错误，无法获取截图');
            
            // 恢复无截图状态
            screenshotImg.classList.add('d-none');
            noScreenshot.classList.remove('d-none');
        });
}

// 按下按键
function pressKey(keyCode) {
    fetch('/key', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ key_code: keyCode })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            showSuccess(data.message || '按键操作成功');
        } else {
            showError(data.message || '按键操作失败');
        }
    })
    .catch(error => {
        console.error('按键操作出错:', error);
        showError('网络错误，无法执行按键操作');
    });
}

// 切换点击功能
function toggleTapFeature(enabled) {
    const screenOverlay = document.getElementById('screen-overlay');
    
    if (!screenOverlay) return;
    
    if (enabled) {
        screenOverlay.classList.remove('d-none');
    } else {
        screenOverlay.classList.add('d-none');
    }
}

// 处理屏幕点击
function handleScreenTap(event) {
    const screenOverlay = document.getElementById('screen-overlay');
    const screenshotImg = document.getElementById('screenshot-img');
    const enableTap = document.getElementById('enable-tap');
    const tapCoordinates = document.getElementById('tap-coordinates');
    
    if (!screenOverlay || !screenshotImg || !enableTap || !enableTap.checked) return;
    
    const rect = screenOverlay.getBoundingClientRect();
    const scaleX = screenshotImg.naturalWidth / rect.width;
    const scaleY = screenshotImg.naturalHeight / rect.height;
    
    const x = Math.round((event.clientX - rect.left) * scaleX);
    const y = Math.round((event.clientY - rect.top) * scaleY);
    
    // 显示点击位置
    if (tapCoordinates) {
        tapCoordinates.textContent = `点击坐标: (${x}, ${y})`;
    }
    
    // 显示点击动画
    const tapIndicator = document.getElementById('tap-indicator');
    if (tapIndicator) {
        tapIndicator.style.left = (event.clientX - rect.left) + 'px';
        tapIndicator.style.top = (event.clientY - rect.top) + 'px';
        tapIndicator.classList.remove('d-none');
        
        setTimeout(() => {
            tapIndicator.classList.add('d-none');
        }, 500);
    }
    
    // 发送点击请求
    fetch('/tap', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ x, y })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            showSuccess(data.message || '点击操作成功');
        } else {
            showError(data.message || '点击操作失败');
        }
    })
    .catch(error => {
        console.error('点击操作出错:', error);
        showError('网络错误，无法执行点击操作');
    });
}

// ===============================
// 任务管理功能
// ===============================

// 加载任务列表
function loadTasks() {
    fetch('/tasks')
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                currentTasks = data.tasks || [];
                updateTaskList();
            } else {
                showError('加载任务失败: ' + (data.message || '未知错误'));
            }
        })
        .catch(error => {
            console.error('加载任务出错:', error);
            showError('网络错误，无法加载任务');
        });
}

// 更新任务列表显示
function updateTaskList() {
    const taskList = document.getElementById('task-list');
    if (!taskList) return;
    
    if (!currentTasks || currentTasks.length === 0) {
        // 显示无任务状态
        taskList.innerHTML = `
            <div class="list-group-item text-center text-muted py-5">
                <i class="bi bi-clipboard-x display-6"></i>
                <p>暂无任务</p>
                <button id="btn-create-first-task" class="btn btn-sm btn-outline-primary">
                    创建第一个任务
                </button>
            </div>
        `;
        
        // 重新绑定创建第一个任务按钮的事件
        const btnCreateFirstTask = document.getElementById('btn-create-first-task');
        if (btnCreateFirstTask) {
            btnCreateFirstTask.addEventListener('click', function() {
                openTaskModal();
            });
        }
    } else {
        // 显示任务列表
        taskList.innerHTML = '';
        
        currentTasks.forEach(task => {
            const taskItem = createTaskListItem(task);
            taskList.appendChild(taskItem);
        });
    }
}

// 创建任务列表项
function createTaskListItem(task) {
    const item = document.createElement('div');
    item.className = 'list-group-item';
    
    const typeLabel = getTaskTypeLabel(task.task_type);
    const statusBadge = task.enabled ? 
        '<span class="badge bg-success">启用</span>' : 
        '<span class="badge bg-secondary">禁用</span>';
    
    item.innerHTML = `
        <div class="d-flex justify-content-between align-items-start">
            <div class="flex-grow-1">
                <h6 class="mb-1">${escapeHtml(task.name)}</h6>
                <p class="mb-1 text-muted small">${escapeHtml(task.description || '无描述')}</p>
                <div class="d-flex gap-2 align-items-center">
                    <span class="badge bg-light text-dark">${typeLabel}</span>
                    ${statusBadge}
                    <small class="text-muted">
                        动作: ${task.actions ? task.actions.length : 0} 个
                        ${task.task_type === 'conditional' ? ` | 条件: ${task.conditions ? task.conditions.length : 0} 个` : ''}
                        ${task.task_type === 'loop' ? ` | 循环: ${task.loop_count || 1} 次` : ''}
                        ${task.children && task.children.length > 0 ? ` | 子任务: ${task.children.length} 个` : ''}
                    </small>
                </div>
            </div>
            <div class="btn-group">
                <button class="btn btn-sm btn-success run-task-btn" data-task-id="${task.id}" title="执行任务">
                    <i class="bi bi-play-fill"></i>
                </button>
                <button class="btn btn-sm btn-outline-secondary edit-task-btn" data-task-id="${task.id}" title="编辑任务">
                    <i class="bi bi-pencil"></i>
                </button>
                <button class="btn btn-sm btn-outline-danger delete-task-btn" data-task-id="${task.id}" title="删除任务">
                    <i class="bi bi-trash"></i>
                </button>
            </div>
        </div>
    `;
    
    // 绑定按钮事件
    const runBtn = item.querySelector('.run-task-btn');
    const editBtn = item.querySelector('.edit-task-btn');
    const deleteBtn = item.querySelector('.delete-task-btn');
    
    if (runBtn) {
        runBtn.addEventListener('click', () => runTask(task.id));
    }
    
    if (editBtn) {
        editBtn.addEventListener('click', () => editTask(task.id));
    }
    
    if (deleteBtn) {
        deleteBtn.addEventListener('click', () => deleteTask(task.id));
    }
    
    return item;
}

// 获取任务类型标签
function getTaskTypeLabel(taskType) {
    switch (taskType) {
        case 'simple': return '简单任务';
        case 'conditional': return '条件任务';
        case 'loop': return '循环任务';
        default: return '未知类型';
    }
}

// 执行任务
function runTask(taskId) {
    fetch(`/tasks/${taskId}/run`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            showSuccess(data.message || '任务执行成功');
        } else {
            showError(data.message || '任务执行失败');
        }
    })
    .catch(error => {
        console.error('执行任务出错:', error);
        showError('网络错误，无法执行任务');
    });
}

// 编辑任务
function editTask(taskId) {
    const task = currentTasks.find(t => t.id === taskId);
    if (!task) {
        showError('找不到指定的任务');
        return;
    }
    
    openTaskModal(task);
}

// 删除任务
function deleteTask(taskId) {
    if (!confirm('确定要删除这个任务吗？')) {
        return;
    }
    
    fetch(`/tasks/${taskId}`, {
        method: 'DELETE'
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            showSuccess(data.message || '任务删除成功');
            loadTasks(); // 重新加载任务列表
        } else {
            showError(data.message || '任务删除失败');
        }
    })
    .catch(error => {
        console.error('删除任务出错:', error);
        showError('网络错误，无法删除任务');
    });
}

// 保存任务到文件
function saveTasks() {
    fetch('/tasks/save', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({})
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            showSuccess(data.message || '任务保存成功');
        } else {
            showError(data.message || '任务保存失败');
        }
    })
    .catch(error => {
        console.error('保存任务出错:', error);
        showError('网络错误，无法保存任务');
    });
}

// 从文件加载任务
function loadTasksFromFile() {
    fetch('/tasks/load', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({})
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            showSuccess(data.message || '任务加载成功');
            currentTasks = data.tasks || [];
            updateTaskList();
        } else {
            showError(data.message || '任务加载失败');
        }
    })
    .catch(error => {
        console.error('加载任务出错:', error);
        showError('网络错误，无法加载任务');
    });
}
